let peer, myNick, connections = [], players = [];
let gameSettings = { rule07: false, ruleMulti: false, maxPlayers: 2 };
let deck = [], playerHand = [], topCard = null, currentColor = "";
let currentPlayerIdx = 0, isMyTurn = false, gameActive = false;

// 1. LOGIN & PEER
document.getElementById("loginBtn").onclick = () => {
    myNick = document.getElementById("nickInput").value.trim();
    if(!myNick) return alert("Inserisci un nome!");
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("startScreen").classList.remove("hidden");
    document.getElementById("welcomeText").innerText = "Ciao, " + myNick;
    
    peer = new Peer(myNick.replace(/\s+/g, '') + "-" + Math.floor(Math.random()*999));
    peer.on('open', id => document.getElementById("myPeerId").innerText = id);
    peer.on('connection', conn => setupHostListeners(conn));
};

// 2. COPIA ID
document.getElementById("copyBtn").onclick = () => {
    const id = document.getElementById("myPeerId").innerText;
    const helper = document.getElementById("copyHelper");
    helper.value = id; helper.select();
    document.execCommand("copy");
    showToast("ID COPIATO! ðŸ“‹");
};

// 3. LOGICA HOST (CHI RICEVE)
function setupHostListeners(conn) {
    conn.on('open', () => {
        if(players.length >= gameSettings.maxPlayers - 1) {
            conn.send({type: 'ERROR', msg: 'Stanza piena!'});
            return;
        }
        connections.push(conn);
        players.push({ nick: conn.metadata.nick, id: conn.peer, handCount: 0 });
        updateStatus();
        conn.on('data', data => handleData(data, conn));
    });
}

// 4. LOGICA CLIENT (CHI SI UNISCE)
document.getElementById("connectBtn").onclick = () => {
    const hostId = document.getElementById("hostIdInput").value.trim();
    const conn = peer.connect(hostId, { metadata: { nick: myNick } });
    conn.on('open', () => {
        connections.push(conn);
        showToast("CONNESSO!");
        conn.on('data', data => handleData(data, conn));
    });
};

// 5. IMPOSTAZIONI
document.getElementById("settingsBtn").onclick = () => document.getElementById("settingsModal").classList.remove("hidden");
document.getElementById("saveSettings").onclick = () => {
    gameSettings.rule07 = document.getElementById("rule07").checked;
    gameSettings.ruleMulti = document.getElementById("ruleMulti").checked;
    gameSettings.maxPlayers = parseInt(document.getElementById("maxPlayersSelect").value);
    document.getElementById("settingsModal").classList.add("hidden");
    updateStatus();
};

function updateStatus() {
    document.getElementById("statusText").innerText = `Giocatori: ${players.length + 1}/${gameSettings.maxPlayers}`;
}

// 6. CHAT
function sendChat(emoji) {
    const msg = { type: 'CHAT', nick: myNick, content: emoji };
    broadcast(msg);
    renderChat(msg);
}

function renderChat(d) {
    const box = document.getElementById("chatMessages");
    box.innerHTML += `<div><strong>${d.nick}:</strong> ${d.content}</div>`;
    box.scrollTop = box.scrollHeight;
}

// 7. GAME ENGINE (START)
document.getElementById("startGameBtn").onclick = () => {
    // Riempi con Bot se mancano umani
    while(players.length < gameSettings.maxPlayers - 1) {
        players.push({ nick: "Bot " + (players.length+1), id: 'BOT', isBot: true, handCount: 0 });
    }
    
    // Genera mazzo e mani
    initDeck();
    playerHand = drawCards(7);
    const hands = players.map(p => drawCards(7));
    topCard = deck.pop();
    currentColor = topCard.color;

    // Sincronizza tutti
    broadcast({
        type: 'START',
        settings: gameSettings,
        topCard, currentColor,
        players: [{nick: myNick, id: peer.id}, ...players],
        yourHand: hands // L'host assegna le mani
    });

    startLocalGame();
};

function initDeck() {
    deck = [];
    const colors = ["red", "blue", "green", "yellow"];
    const vals = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "skip", "reverse", "draw2"];
    colors.forEach(c => vals.forEach(v => { deck.push({color: c, value: v}); if(v!=="0") deck.push({color: c, value: v}); }));
    for(let i=0; i<4; i++) { deck.push({color: "wild", value: "W"}, {color: "wild4", value: "W4"}); }
    deck.sort(() => Math.random() - 0.5);
}

function drawCards(n) {
    let drawn = [];
    for(let i=0; i<n; i++) if(deck.length > 0) drawn.push(deck.pop());
    return drawn;
}

function broadcast(data) {
    connections.forEach(c => { if(c.open) c.send(data); });
}

function handleData(d, conn) {
    if(d.type === 'CHAT') renderChat(d);
    if(d.type === 'ERROR') alert(d.msg);
    if(d.type === 'START') {
        gameSettings = d.settings;
        topCard = d.topCard;
        currentColor = d.currentColor;
        // Trova la propria mano nell'array inviato dall'host
        const myIdx = d.players.findIndex(p => p.id === peer.id);
        playerHand = d.yourHand[myIdx - 1]; 
        startLocalGame();
    }
}

function startLocalGame() {
    document.getElementById("startScreen").classList.add("hidden");
    document.getElementById("gameArea").classList.remove("hidden");
    gameActive = true;
    isMyTurn = true; // Semplificato: l'host inizia sempre
    renderGame();
}

function renderGame() {
    // Rendering scarto
    const disc = document.getElementById("discardPile");
    disc.innerHTML = `<div class="card ${currentColor}">${topCard.value}</div>`;
    
    // Rendering mano
    const handDiv = document.getElementById("playerHand");
    handDiv.innerHTML = "";
    playerHand.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = `card ${c.color}`;
        div.innerText = c.value;
        div.onclick = () => playCard(i);
        handDiv.appendChild(div);
    });
}

function showToast(m) {
    const t = document.createElement("div"); t.className = "toast"; t.innerText = m;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

// Inserisci qui le funzioni playCard, botTurn e le logiche 0-7...
